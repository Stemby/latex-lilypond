#!/usr/bin/env python

import os, sys
from ConfigParser import ConfigParser
from subprocess import Popen

def lilyconf(cw, dn):
    f = open(os.path.join(dn, 'config.ly'), 'w')
    f.write(
'''%% Automatically generated by lilytex

%% no indent
%% line-width = LaTeX \columnwidth
%% no titles

\paper {
  indent=0\mm
  line-width=%s\pt
  oddFooterMarkup=##f
  oddHeaderMarkup=##f
  bookTitleMarkup = ##f
  scoreTitleMarkup = ##f
}


%% no bar numbers

\layout {
  \context {
    \Score
    \\remove "Bar_number_engraver"
  }
}
''' % cw[:-2])
    f.close()

def main():
    lil = ConfigParser()
    lil.read(sys.argv[1])
    path = lil.get('Config','filename')
    dirname = os.path.dirname(path)
    basename = os.path.basename(path)
    columnwidth = lil.get('Config','columnwidth')
    lilyconf(columnwidth, dirname)
    # See:
    # http://lilypond.org/doc/v2.13/Documentation/usage/lilypond-output-in-other-programs
    args = ['lilypond', '-dbackend=eps', '-dno-gs-load-fonts',
            '-dinclude-eps-fonts', basename]
    if dirname == '':
        p = Popen(args)
    else:
        p = Popen(args, cwd=dirname)
    p.wait()

if __name__ == '__main__':
    main()
