#!/usr/bin/env python

import os, sys
from ConfigParser import ConfigParser
from subprocess import Popen
from string import Template

def main():
    lil = ConfigParser()
    lil.read(sys.argv[1])
    path = lil.get('General', 'filename')
    dirname = os.path.dirname(path)
    basename = os.path.basename(path)
    columnwidth = lil.get('General', 'columnwidth')[:-2]
    staffsize = lil.get('Options', 'staffsize')[:-2]
    Staffsize = ''
    if staffsize != '0.0':
        Staffsize = '''
#(set-global-staff-size %s)
''' % staffsize
    betweensystemspace = lil.get('Options', 'between-system-space')[:-2]
    config = Template(
'''%% Automatically generated by lilytex
%% staff size: set by option
%% no indent
%% line-width = LaTeX \columnwidth
%% no titles
%% between-system-space (distance between systems): set by option
%% betweeb-system-padding: ???
%%
$Staffsize

\paper {
  indent = 0\mm
  line-width = $columnwidth\pt
  oddFooterMarkup = ##f
  oddHeaderMarkup = ##f
  bookTitleMarkup = ##f
  scoreTitleMarkup = ##f
  between-system-space = $bss\pt
  between-system-padding = #1
}


%% no bar numbers

\layout {
  \context {
    \Score
    \\remove "Bar_number_engraver"
  }
}
''')
    f = open(os.path.join(dirname, 'config.ly'), 'w')
    f.write(config.substitute(
        columnwidth=columnwidth,
        Staffsize=Staffsize,
        bss=betweensystemspace))
    f.close()
    # See:
    # http://lilypond.org/doc/v2.13/Documentation/usage/lilypond-output-in-other-programs
    args = ['lilypond', '-dbackend=eps', '-dno-gs-load-fonts',
            '-dinclude-eps-fonts', basename]
    if dirname == '':
        p = Popen(args)
    else:
        p = Popen(args, cwd=dirname)
    p.wait()

if __name__ == '__main__':
    main()

